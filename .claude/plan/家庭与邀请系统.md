# 家庭与邀请系统 - 实施计划

**创建时间**：2026-02-06
**项目**：宝宝成长相册 (Baby Photos Album)
**实施阶段**：Phase 4

---

## 📋 项目概述

实现多家庭管理与邀请系统，支持用户创建/加入多个家庭、管理成员角色、通过邀请码扩展团队。

### 核心功能
- ✅ 多家庭管理（创建、查看、更新、删除）
- ✅ 成员管理（添加、移除、角色变更：OWNER/ADMIN/MEMBER/VIEWER）
- ✅ 邀请机制（6-8位邀请码、7天有效期、生成/验证/接受/拒绝）
- ✅ 家庭切换（全局状态管理、无缝数据刷新）

### 技术栈
**后端**：NestJS + Prisma + SQLite + JWT
**前端**：React 18 + TypeScript + Zustand + TanStack Query + Tailwind CSS

---

## 🏗️ 后端架构设计

### 模块结构
```
backend/src/
├── access/
│   ├── family-access.service.ts  # 统一RBAC权限检查
│   └── role.enum.ts              # 角色枚举定义
├── families/
│   ├── dto/
│   │   ├── create-family.dto.ts
│   │   ├── update-family.dto.ts
│   │   ├── add-member.dto.ts
│   │   ├── update-member-role.dto.ts
│   │   └── transfer-owner.dto.ts
│   ├── families.module.ts
│   ├── families.controller.ts
│   └── families.service.ts
└── invitations/
    ├── dto/
    │   ├── create-invitation.dto.ts
    │   ├── verify-invitation.dto.ts
    │   ├── accept-invitation.dto.ts
    │   └── reject-invitation.dto.ts
    ├── invitations.module.ts
    ├── invitations.controller.ts
    └── invitations.service.ts
```

### DTO定义

**FamiliesModule DTOs**：
1. `CreateFamilyDto` - `{ name: string }`
2. `UpdateFamilyDto` - `{ name?: string }`
3. `AddMemberDto` - `{ userId: string, role: "ADMIN"|"MEMBER"|"VIEWER" }`
4. `UpdateMemberRoleDto` - `{ role: "ADMIN"|"MEMBER"|"VIEWER" }`
5. `TransferOwnerDto` - `{ newOwnerId: string }`

**InvitationsModule DTOs**：
1. `CreateInvitationDto` - `{ role: "ADMIN"|"MEMBER"|"VIEWER", inviteeEmail?: string }`
2. `VerifyInvitationDto` - `{ code: string }`
3. `AcceptInvitationDto` - `{ code: string }`
4. `RejectInvitationDto` - `{ code: string }`

### Service层设计

**FamilyAccessService（统一RBAC）**：
```typescript
class FamilyAccessService {
  getMembership(userId, familyId)
  assertMember(userId, familyId)
  assertRoleAtLeast(userId, familyId, minRole)
  assertOwner(userId, familyId)
  canManageMembers(role)
  canInvite(role)
  canUpdateFamily(role)
}
```

**FamiliesService**：
```typescript
class FamiliesService {
  createFamily(userId, dto)
  getMyFamilies(userId, query)
  getFamily(userId, familyId)
  updateFamily(userId, familyId, dto)
  deleteFamily(userId, familyId)
  addMember(userId, familyId, dto)
  updateMemberRole(userId, familyId, targetUserId, dto)
  removeMember(userId, familyId, targetUserId)
  transferOwner(userId, familyId, dto)
}
```

**InvitationsService**：
```typescript
class InvitationsService {
  createInvite(userId, dto)
  verifyInvite(code)
  acceptInvite(userId, dto)
  rejectInvite(userId, dto)
  listInvites(userId, query)
  expireOutdatedInvites()
}
```

### API路由规划

**家庭管理（FamiliesModule）**：
```
POST   /api/v1/families                    # 创建家庭
GET    /api/v1/families                    # 获取我的家庭列表
GET    /api/v1/families/:id                # 获取家庭详情
PATCH  /api/v1/families/:id                # 更新家庭信息
DELETE /api/v1/families/:id                # 删除家庭（仅OWNER）
POST   /api/v1/families/:id/members        # 添加成员
PATCH  /api/v1/families/:id/members/:userId # 修改成员角色
DELETE /api/v1/families/:id/members/:userId # 移除成员
POST   /api/v1/families/:id/transfer-owner # 转让所有权
```

**邀请管理（InvitationsModule）**：
```
POST   /api/v1/invitations                 # 创建邀请
GET    /api/v1/invitations                 # 获取邀请列表
POST   /api/v1/invitations/verify         # 验证邀请码
POST   /api/v1/invitations/accept         # 接受邀请
POST   /api/v1/invitations/reject         # 拒绝邀请
```

### 数据库事务设计

**创建家庭**：
```typescript
prisma.$transaction(async (tx) => {
  const family = await tx.family.create({ data: { name, ownerId: userId } });
  await tx.familyMember.create({ data: { familyId: family.id, userId, role: 'OWNER' } });
  return family;
})
```

**接受邀请**：
```typescript
prisma.$transaction(async (tx) => {
  const invitation = await tx.familyInvitation.findUnique({ where: { code } });
  // 验证：PENDING + 未过期
  await tx.familyInvitation.update({
    where: { id: invitation.id },
    data: { status: 'ACCEPTED', acceptedAt: new Date() }
  });
  await tx.familyMember.create({
    data: { familyId: invitation.familyId, userId, role: invitation.role }
  });
})
```

**转让所有权**：
```typescript
prisma.$transaction(async (tx) => {
  await tx.familyMember.update({
    where: { familyId_userId: { familyId, userId } },
    data: { role: 'ADMIN' }
  });
  await tx.familyMember.update({
    where: { familyId_userId: { familyId, dto.newOwnerId } },
    data: { role: 'OWNER' }
  });
  await tx.family.update({
    where: { id: familyId },
    data: { ownerId: dto.newOwnerId }
  });
})
```

### 安全机制
- **邀请码生成**：base62编码，6-8位，唯一性检测，最多5次重试
- **权限检查**：所有操作通过FamilyAccessService统一验证
- **角色保护**：禁止移除/降级最后一个OWNER
- **过期处理**：查询时过滤 `expiresAt < now()`，自动标记EXPIRED

---

## 🎨 前端架构设计

### 目录结构
```
frontend/src/
├── store/
│   └── familyStore.ts              # Zustand全局家庭状态
├── features/
│   ├── family/
│   │   ├── components/
│   │   │   ├── FamilySwitcher.tsx  # 全局家庭切换器
│   │   │   ├── MemberList.tsx      # 成员列表
│   │   │   └── FamilySettings.tsx  # 家庭设置表单
│   │   ├── hooks/
│   │   │   ├── useFamilies.ts      # TanStack Query hooks
│   │   │   └── useFamilyMembers.ts
│   │   └── pages/
│   │       ├── FamilyLayout.tsx    # 家庭管理共享布局
│   │       ├── FamilyMembersPage.tsx
│   │       └── FamilySettingsPage.tsx
│   └── invitations/
│       ├── components/
│       │   ├── CreateInvitation.tsx  # 邀请码生成器
│       │   ├── InvitationList.tsx    # 邀请列表
│       │   └── AcceptInvitation.tsx  # 接受邀请界面
│       ├── hooks/
│       │   ├── useCreateInvitation.ts
│       │   └── useAcceptInvitation.ts
│       └── pages/
│           ├── ManageInvitationsPage.tsx
│           └── AcceptInvitationPage.tsx
├── components/
│   ├── layout/
│   │   ├── Navbar.tsx              # 顶部导航（含FamilySwitcher）
│   │   └── ProtectedRoute.tsx      # 路由守卫
│   └── ui/
│       ├── Button.tsx
│       ├── Modal.tsx
│       ├── Spinner.tsx
│       ├── Toast.tsx               # 反馈提示
│       └── QRCode.tsx              # 二维码展示
├── api/
│   ├── familyApi.ts
│   └── invitationApi.ts
└── types/
    ├── family.d.ts
    └── user.d.ts
```

### 状态管理（Zustand）

**familyStore.ts**：
```typescript
interface FamilyState {
  families: Family[];                  // 用户所属的所有家庭
  currentFamilyId: string | null;      // 当前激活的家庭ID
  setFamilies: (families: Family[]) => void;
  setCurrentFamilyId: (familyId: string) => void;
  activeFamily: () => Family | undefined;
  clear: () => void;
}

// 持久化到localStorage
export const useFamilyStore = create<FamilyState>()(
  persist(
    (set, get) => ({
      families: [],
      currentFamilyId: null,
      setFamilies: (families) => set({ families }),
      setCurrentFamilyId: (familyId) => set({ currentFamilyId: familyId }),
      activeFamily: () => {
        const { families, currentFamilyId } = get();
        return families.find(f => f.id === currentFamilyId);
      },
      clear: () => set({ families: [], currentFamilyId: null }),
    }),
    {
      name: 'family-context',
      partialize: (state) => ({ currentFamilyId: state.currentFamilyId })
    }
  )
);
```

### 路由设计

```tsx
<BrowserRouter>
  <Navbar />
  <main>
    <Routes>
      {/* 公开路由 */}
      <Route path="/login" element={<LoginPage />} />
      <Route path="/invite/:token" element={<AcceptInvitationPage />} />

      {/* 保护路由 */}
      <Route element={<ProtectedRoute />}>
        <Route path="/" element={<HomePage />} />

        {/* 家庭管理嵌套路由 */}
        <Route path="/family/:familyId" element={<FamilyLayout />}>
          <Route index element={<FamilyMembersPage />} />
          <Route path="members" element={<FamilyMembersPage />} />
          <Route path="invitations" element={<ManageInvitationsPage />} />
          <Route path="settings" element={<FamilySettingsPage />} />
        </Route>
      </Route>
    </Routes>
  </main>
</BrowserRouter>
```

### UI组件设计

**FamilySwitcher（全局家庭切换器）**：
- 位置：Navbar中央或左侧
- 显示：当前家庭名称 + chevron-down图标
- 下拉内容：家庭列表 + "创建新家庭" + "加入家庭"
- 交互：选择后切换 `currentFamilyId` + 导航到对应家庭页

**CreateInvitation（邀请码生成器）**：
- 触发：Button打开Modal
- Modal内容：
  - 角色选择下拉框（ADMIN/MEMBER/VIEWER）
  - "生成邀请码"按钮
  - 成功后显示：
    - 只读输入框（邀请链接）
    - "复制链接"按钮
    - 二维码展示
    - 提示："有效期7天，仅限一人使用"

**MemberList（成员列表）**：
- 布局：垂直列表
- 每项显示：头像 + 昵称 + 角色标签（颜色区分）
- 管理员操作："更多"(...)菜单 → "设为管理员"/"移出家庭"
- 顶部："+ 邀请新成员"按钮

**AcceptInvitation（接受邀请界面）**：
- 布局：居中卡片
- 内容：
  - 邀请者头像 + 姓名
  - "邀请您加入 **[家庭名称]**"
  - 主按钮："接受邀请"
  - 次按钮："拒绝"

### 数据流设计

**登录流程**：
```
LoginPage (登录成功)
  ↓
useFamilies() → GET /api/v1/families
  ↓
familyStore.setFamilies()
  ↓
设置默认家庭（currentFamilyId）
  ↓
导航到 /family/:id/members
```

**家庭切换流程**：
```
FamilySwitcher (选择新家庭)
  ↓
familyStore.setCurrentFamilyId(newId)
  ↓
useEffect监听 currentFamilyId 变化
  ↓
navigate(`/family/${newId}/members`)
  ↓
TanStack Query自动重新获取数据
  ↓
页面内容平滑过渡
```

**创建邀请流程**：
```
点击"生成邀请码"
  ↓
useCreateInvitation.mutate({ familyId, role })
  ↓
POST /api/v1/invitations
  ↓
显示Modal（链接 + 二维码 + 复制按钮）
  ↓
用户复制链接分享
```

**接受邀请流程**：
```
访问 /invite/:token
  ↓
提取邀请码token
  ↓
未登录？→ 跳转 /login，state记录returnUrl
  ↓
已登录？→ useAcceptInvitation.mutate({ token })
  ↓
POST /api/v1/invitations/accept
  ↓
成功 → invalidateQueries('families')
  ↓
更新 familyStore
  ↓
跳转到新家庭页面
```

---

## 🚀 实施步骤

### Phase 1：后端基础（优先）
1. 创建 `access` 模块 + `FamilyAccessService`
2. 实现 `FamiliesModule`（CRUD + 成员管理）
3. 实现 `InvitationsModule`（邀请码生命周期）

### Phase 2：前端基础
4. 创建 `familyStore` + API层
5. 实现 `FamilySwitcher` 全局组件
6. 实现家庭管理界面（成员列表）

### Phase 3：邀请流程
7. 实现邀请码生成与展示
8. 实现接受邀请流程
9. 集成测试与优化

---

## 📊 成功标准

### 功能完整性
- ✅ 用户可创建多个家庭并快速切换
- ✅ 家庭管理员可管理成员角色
- ✅ 邀请码生成/验证/接受/拒绝全流程
- ✅ 权限控制严格执行（OWNER/ADMIN/MEMBER/VIEWER）

### 安全性
- ✅ 所有操作通过JWT认证保护
- ✅ RBAC权限集中检查
- ✅ 邀请码唯一性 + 过期验证
- ✅ 事务保证数据一致性

### 用户体验
- ✅ 家庭切换流畅（自动刷新数据）
- ✅ 邀请码易于分享（链接 + 二维码）
- ✅ 操作反馈清晰（Toast + Loading）
- ✅ 移动端友好（大按钮、简洁布局）

---

## 📝 备注

- **邀请码格式**：使用 `nanoid` 或自定义base62生成器
- **事务处理**：关键操作使用Prisma `$transaction` 确保原子性
- **错误处理**：统一异常处理 + 友好错误提示
- **测试策略**：先单元测试Service层，再集成测试API

---

**状态**：待用户批准进入执行阶段
