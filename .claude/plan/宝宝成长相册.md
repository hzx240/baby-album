# 宝宝成长相册 - 实施计划

**项目类型**：前后端分离 Web 应用
**创建时间**：2026-02-06 16:53:35
**架构选择**：React 前端 + NestJS 后端 + PostgreSQL + S3 存储

---

## 📋 项目概述

构建一个私密、安全的宝宝成长照片存储与展示平台，**支持多家庭模式**，用户可以创建或加入多个家庭，通过邀请机制管理成员，移动端自适应设计。

### 核心功能
- ✅ 多家庭管理（用户可创建/加入多个家庭）
- ✅ 邀请机制（生成邀请链接/码，邀请加入家庭）
- ✅ 家庭切换（在不同家庭间快速切换）
- ✅ 照片上传与管理（批量支持）
- ✅ 时间线展示（按日期/年龄组织）
- ✅ 自适应响应式设计（移动端优先）
- ✅ 访问权限控制（注册制 + RBAC）
- ✅ 审计日志（完整安全追踪）

---

## 🏗️ 技术架构

### 前端技术栈
- **框架**：React 18 + TypeScript
- **构建工具**：Vite
- **路由**：React Router v6
- **状态管理**：Zustand
- **数据请求**：TanStack Query (React Query)
- **样式**：Tailwind CSS
- **图标**：Lucide Icons / Heroicons
- **图片网格**：react-photo-album（瀑布流布局）

### 后端技术栈
- **框架**：NestJS (Node.js)
- **数据库**：PostgreSQL
- **ORM**：Prisma
- **认证**：JWT + Refresh Token
- **文件存储**：S3 兼容对象存储 (MinIO/云存储)
- **图片处理**：Sharp
- **验证**：class-validator

### 安全机制
- **密码加密**：bcrypt/argon2
- **Token 策略**：短期 Access Token (15min) + 长期 Refresh Token (30d)
- **RBAC**：OWNER / ADMIN / MEMBER / VIEWER
- **S3 访问**：预签名 URL，短期有效
- **审计日志**：所有敏感操作记录

---

## 📁 目录结构

### 前端目录
```
/src
|-- /api                # TanStack Query 封装
|   |-- /auth           # 认证 API
|   |-- /photos         # 照片 API
|   |-- /families       # 家庭/成员 API
|   |-- index.ts        # API 客户端实例
|
|-- /components
|   |-- /common         # Button, Input, Spinner, Avatar
|   |-- /layout         # Header, PageWrapper
|   |-- /feature        # PhotoGrid, UploadModal, Timeline
|
|-- /hooks              # useAuth, useMediaQuery
|-- /pages
|   |-- /auth           # 登录、注册
|   |-- /timeline       # 时间线主页
|   |-- /album          # 相册集
|   |-- /settings       # 设置
|
|-- /router             # 路由配置 + PrivateRoute
|-- /store
|   |-- authStore.ts    # 认证状态
|   |-- familyStore.ts  # 家庭状态（当前家庭、家庭列表）
|   |-- photoStore.ts   # 照片状态
|
|-- /styles             # Tailwind + 全局样式
|-- App.tsx
|-- main.tsx
```

### 后端目录
```
/src
|-- /modules
|   |-- /auth           # 认证模块
|   |-- /users          # 用户模块
|   |-- /families       # 家庭/成员模块
|   |-- /media          # 照片上传与管理
|   |-- /audit          # 审计日志
|
|-- /common
|   |-- /guards         # JWT 守卫 + RBAC
|   |-- /decorators     # 自定义装饰器
|   |-- /filters        # 异常过滤
|
|-- /config             # 配置文件
|-- /database           # Prisma schema
|-- main.ts
```

---

## 🛣️ 路由设计

### 前端路由
| 路径 | 组件 | 说明 |
|------|------|------|
| `/` | Timeline | 时间线首页（需认证，基于当前家庭） |
| `/login` | Login | 登录页 |
| `/register` | Register | 注册页 |
| `/families` | Families | 家庭列表/管理页面 |
| `/families/create` | CreateFamily | 创建新家庭 |
| `/families/:id` | FamilyDetail | 家庭详情 |
| `/invitations` | Invitations | 待处理邀请列表 |
| `/album/:year(/:month)` | Album | 相册集（按年月） |
| `/photo/:id` | PhotoDetail | 照片详情（Modal） |
| `/upload` | Upload | 上传页面 |
| `/settings` | Settings | 设置页 |
| `*` | NotFound | 404 |

### 后端 API
#### 认证 & 用户
```
POST   /api/v1/auth/register
POST   /api/v1/auth/login
POST   /api/v1/auth/refresh
POST   /api/v1/auth/logout
POST   /api/v1/auth/forgot-password
POST   /api/v1/auth/reset-password
GET    /api/v1/users/me
PATCH  /api/v1/users/me
```

#### 家庭 & 成员
```
POST   /api/v1/families                    # 创建新家庭
GET    /api/v1/families                    # 获取我的所有家庭列表
GET    /api/v1/families/:id                # 获取家庭详情
PATCH  /api/v1/families/:id                # 更新家庭信息
DELETE /api/v1/families/:id                # 删除家庭（仅 OWNER）
POST   /api/v1/families/:id/switch         # 切换当前活跃家庭
POST   /api/v1/families/:id/invite         # 生成邀请链接/码
GET    /api/v1/families/:id/members        # 获取家庭成员列表
PATCH  /api/v1/families/:id/members/:userId # 修改成员角色
DELETE /api/v1/families/:id/members/:userId # 移除成员
```

#### 邀请管理
```
GET    /api/v1/invitations                 # 获取我的待处理邀请
POST   /api/v1/invitations/:code/accept    # 接受邀请（通过邀请码）
POST   /api/v1/invitations/:id/accept      # 接受邀请（通过邀请 ID）
POST   /api/v1/invitations/:id/reject      # 拒绝邀请
DELETE /api/v1/invitations/:id             # 删除邀请记录
```

#### 照片媒体
```
POST   /api/v1/media/request-upload   # 获取 S3 预签名 URL
POST   /api/v1/media/complete-upload  # 确认上传 + 保存元数据
GET    /api/v1/media                  # 列出照片（分页、筛选）
GET    /api/v1/media/:id              # 获取照片元数据
DELETE /api/v1/media/:id              # 删除照片
```

---

## 🗄️ 数据库 Schema

```sql
-- 用户表
CREATE TABLE users (
  id UUID PRIMARY KEY,
  email TEXT UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  display_name TEXT,
  status TEXT NOT NULL DEFAULT 'ACTIVE',
  created_at TIMESTAMP NOT NULL DEFAULT now(),
  updated_at TIMESTAMP NOT NULL DEFAULT now()
);

-- 家庭表
CREATE TABLE families (
  id UUID PRIMARY KEY,
  name TEXT NOT NULL,
  owner_id UUID NOT NULL REFERENCES users(id),
  created_at TIMESTAMP NOT NULL DEFAULT now()
);

-- 家庭成员关系表
CREATE TABLE family_members (
  family_id UUID REFERENCES families(id),
  user_id UUID REFERENCES users(id),
  role TEXT NOT NULL,  -- OWNER, ADMIN, MEMBER, VIEWER
  created_at TIMESTAMP NOT NULL DEFAULT now(),
  PRIMARY KEY (family_id, user_id)
);

-- 照片表
CREATE TABLE photos (
  id UUID PRIMARY KEY,
  family_id UUID NOT NULL REFERENCES families(id),
  uploader_id UUID NOT NULL REFERENCES users(id),
  original_key TEXT NOT NULL,
  resized_key TEXT,
  thumb_key TEXT,
  taken_at TIMESTAMP,
  uploaded_at TIMESTAMP NOT NULL DEFAULT now(),
  checksum TEXT,
  file_size BIGINT,
  mime_type TEXT
);

-- 照片标签表
CREATE TABLE photo_tags (
  photo_id UUID REFERENCES photos(id),
  tag TEXT NOT NULL,
  PRIMARY KEY (photo_id, tag)
);

-- Refresh Token 表
CREATE TABLE refresh_tokens (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES users(id),
  token_hash TEXT NOT NULL,
  expires_at TIMESTAMP NOT NULL,
  revoked_at TIMESTAMP
);

-- 审计日志表
CREATE TABLE audit_logs (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id),
  action TEXT NOT NULL,
  target_id UUID,
  ip TEXT,
  created_at TIMESTAMP NOT NULL DEFAULT now()
);

-- 家庭邀请表
CREATE TABLE family_invitations (
  id UUID PRIMARY KEY,
  family_id UUID NOT NULL REFERENCES families(id),
  inviter_id UUID NOT NULL REFERENCES users(id),
  invitee_email TEXT,                      -- 被邀请人邮箱（可选）
  invite_code TEXT UNIQUE NOT NULL,        -- 邀请码（6-8 位随机字符串）
  role TEXT NOT NULL DEFAULT 'MEMBER',     -- 邀请时的角色
  status TEXT NOT NULL DEFAULT 'PENDING',  -- PENDING, ACCEPTED, REJECTED, EXPIRED
  expires_at TIMESTAMP NOT NULL,           -- 邀请过期时间（通常 7 天）
  accepted_at TIMESTAMP,                   -- 接受时间
  created_at TIMESTAMP NOT NULL DEFAULT now()
);

-- 索引
CREATE INDEX idx_photos_family_uploaded ON photos(family_id, uploaded_at DESC);
CREATE INDEX idx_photos_family_taken ON photos(family_id, taken_at DESC);
CREATE INDEX idx_audit_user_created ON audit_logs(user_id, created_at DESC);
CREATE INDEX idx_invitations_code ON family_invitations(invite_code);
CREATE INDEX idx_invitations_status ON family_invitations(status, expires_at);
```

---

## 🔗 邀请机制设计

### 邀请流程

#### 1. 创建邀请
1. 家庭管理员（OWNER/ADMIN）进入邀请管理页面
2. 选择邀请角色（MEMBER/VIEWER）
3. 可选输入被邀请人邮箱
4. 系统生成 6-8 位随机邀请码（如：`ABC123XY`）
5. 生成邀请链接（如：`https://app.com/invite/ABC123XY`）
6. 设置过期时间（默认 7 天）
7. 管理员分享链接或二维码给被邀请人

#### 2. 接受邀请
1. 被邀请人点击邀请链接或输入邀请码
2. 系统验证邀请码有效性：
   - 邀请码存在
   - 未过期
   - 状态为 PENDING
3. 如果未登录，提示先登录/注册
4. 登录后显示预览：家庭名称、邀请人、邀请角色
5. 用户选择"接受"或"拒绝"
6. 接受后：
   - 创建 family_members 记录
   - 更新邀请状态为 ACCEPTED
   - 记录 accepted_at 时间戳
   - 添加审计日志
   - 将该家庭设为当前家庭

#### 3. 邀请过期
- 系统在每次查询邀请时检查过期时间
- 可选：定时任务将过期邀请状态标记为 EXPIRED
- 过期邀请不可再接受

### 安全考虑

- ✅ 邀请码随机生成，足够长度（6-8 位）防止暴力破解
- ✅ 邀请链接包含过期时间戳，前端可显示倒计时
- ✅ 仅管理员（OWNER/ADMIN）可创建邀请
- ✅ 每个邀请码只能使用一次
- ✅ 已拒绝的邀请不能重复接受
- ✅ 审计日志记录所有邀请操作

### 数据隔离

- 用户只能看到发给自己的待处理邀请
- 家庭管理员只能看到自己家庭的邀请记录
- 邀请接受后自动加入对应家庭，获得指定角色权限

---

## 🎨 UI/UX 设计指南

### 设计原则
- **简洁温馨**：大量留白，柔和色彩（奶油色、浅灰、温暖橙色/蓝色点缀）
- **照片为中心**：最小化UI干扰，突出内容
- **移动优先**：针对触摸操作优化

### 核心界面

#### 0. 家庭选择器（全局）
- 顶部导航栏显示当前家庭名称
- 点击展开下拉列表，显示所有家庭
- 快速切换家庭
- "创建新家庭"和"查看邀请"入口

#### 1. 时间线首页
- 全屏倒序时间线
- 无限滚动加载
- 按日期分组显示
- 懒加载优化性能
- 基于当前选中的家庭

#### 2. 照片网格
- 响应式瀑布流布局（react-photo-album）
- 移动端：1-2 列
- 平板：3-4 列
- 桌面：多列，侧边留白

#### 3. 上传界面
- 拖拽上传支持
- 批量文件选择
- 实时进度显示
- 右上角常驻入口
- 上传到当前选中家庭

#### 4. 照片详情
- 全屏 Modal 展示
- 键盘左右键切换
- 显示 EXIF/元数据
- 日期和描述编辑

#### 5. 邀请管理界面
- **生成邀请**：
  - 输入被邀请人邮箱（可选）
  - 选择邀请角色（MEMBER/VIEWER）
  - 生成邀请链接/码
  - 复制链接或二维码分享
- **待处理邀请**：
  - 显示所有发给当前用户的邀请
  - 查看家庭信息、邀请人
  - 一键接受/拒绝

### 字体与图标
- **字体**：Nunito / Quicksand（圆润易读）
- **图标**：Lucide Icons / Heroicons

---

## 🔐 安全实施要点

### 认证安全
- ✅ JWT 存储在内存（Zustand），不用 localStorage
- ✅ Refresh Token 通过 HttpOnly + Secure Cookie
- ✅ 密码强度验证（最少 8 位，含大小写+数字）
- ✅ 可选 MFA（未来扩展）

### 授权安全
- ✅ 每个请求验证 family_id 匹配
- ✅ RBAC 权限检查（OWNER/ADMIN/MEMBER/VIEWER）
- ✅ 敏感操作审计日志

### 文件安全
- ✅ S3 预签名 URL 短期有效
- ✅ 文件类型校验（MIME + 扩展名 + Magic Bytes）
- ✅ 文件大小限制
- ✅ 病毒扫描（可选 ClamAV）

### 前端安全
- ✅ 所有用户内容转义（防 XSS）
- ✅ CSRF Token
- ✅ HTTPS 强制

---

## 🚀 实施步骤

### Phase 1: 项目初始化
1. **后端初始化**
   - 创建 NestJS 项目
   - 配置 Prisma + PostgreSQL
   - 配置环境变量
   - 设置基础中间件（CORS, ValidationPipe）

2. **前端初始化**
   - 创建 Vite + React + TypeScript 项目
   - 配置 Tailwind CSS
   - 配置 React Router
   - 安装核心依赖（Zustand, TanStack Query）

### Phase 2: 认证系统
1. **后端**
   - 实现 AuthModule（注册、登录、刷新）
   - JWT 策略 + 守卫
   - Prisma schema 定义

2. **前端**
   - 创建 authStore
   - 实现 Login/Register 页面
   - PrivateRoute 守卫
   - API 客户端封装（带 Token 注入）

### Phase 3: 核心功能 - 照片管理
1. **后端**
   - MediaModule（上传、元数据管理）
   - S3 集成（预签名 URL）
   - Sharp 图片处理（缩略图）

2. **前端**
   - UploadModal 组件
   - PhotoGrid 瀑布流
   - Timeline 页面
   - TanStack Query 集成

### Phase 4: 家庭与邀请系统
1. **后端**
   - FamiliesModule（家庭 CRUD、多家庭列表）
   - InvitationsModule（邀请码生成、验证、接受/拒绝）
   - 家庭切换逻辑（currentFamilyId）
   - RBAC 守卫 + 装饰器
   - 邀请过期检查（定时任务或查询时验证）

2. **前端**
   - familyStore（管理家庭列表和当前家庭）
   - 家庭选择器组件（Header 集成）
   - 创建家庭页面
   - 邀请管理界面
   - 待处理邀请列表
   - 成员管理界面
   - 权限控制 UI

### Phase 5: 安全增强
1. **后端**
   - 审计日志（AuditModule）
   - 文件类型严格校验
   - 速率限制

2. **前端**
   - XSS 防护
   - 安全头部配置

### Phase 6: 优化与部署
1. **性能优化**
   - 图片懒加载
   - 代码分割（React.lazy）
   - 虚拟化（大量照片时）

2. **部署**
   - Docker Compose 配置
   - Nginx 反向代理 + TLS
   - 数据库备份策略
   - S3 版本控制

---

## 📊 成功标准

### 功能完整性
- ✅ 用户注册/登录流程
- ✅ 多家庭管理（创建、加入、切换）
- ✅ 邀请机制（生成邀请链接、接受/拒绝邀请）
- ✅ 照片上传（批量）
- ✅ 时间线展示（基于当前家庭）
- ✅ 相册集浏览
- ✅ 成员权限管理
- ✅ 审计日志查询

### 安全性
- ✅ 未授权访问被拦截
- ✅ 所有敏感操作有日志
- ✅ 文件上传安全
- ✅ Token 刷新正常

### 性能
- ✅ 首屏加载 < 2s
- ✅ 图片懒加载流畅
- ✅ API 响应 < 500ms

### 用户体验
- ✅ 移动端操作流畅
- ✅ 上传进度清晰
- ✅ 错误提示友好

---

## 🎯 下一步行动

1. **用户确认**：批准此计划
2. **创建项目骨架**：初始化前后端项目
3. **设置开发环境**：配置本地数据库 + MinIO
4. **开始 Phase 1**：项目初始化

---

## 📝 备注

- 使用 Docker Compose 简化本地开发环境搭建
- 前端和后端可并行开发，通过 Mock 数据先行
- 所有敏感信息通过环境变量管理
- 定期数据库备份 + S3 版本控制
